<!doctype html>
<html lang="en">


<head>
    <title>Sight-C-ing</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="dashboard.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body onload="setup()">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script src="togeojson.js"></script>

    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-toggleable-md navbar-inverse fixed-top bg-primary">
        <a class="navbar-brand font-weight-bold mx-auto" href="#" style="font-size:2.25rem">Sight-C-ing</a>
    </nav>

    <!-- Side Navigation Bar -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-3 hidden-xs-down bg-faded sidebar" style="top:77px">
                <div class="col-sm-12">
                    <h6 style="margin-bottom:16px">Upload you own route!</h6>
                    <input class="form-control" style="margin-bottom:16px" id="gpxtext" type="text" placeholder="Upload GPX file here" readonly>
                    <p>
                        <input style="display:none" type="file" id="myFile">
                        <input class="btn btn-primary" id='uploadbtn' type='button' value='Upload' style="cursor:pointer" />
                    </p>

                    <p></p>

                    <div id="distanceMatrix" hidden="hidden">
                        <font class="card-text" style="font-size:22px">
                            <img class="w-15" src="https://cdn0.iconfinder.com/data/icons/thin-navigation/24/thin-0545_map_travel_distance_directions-512.png" alt="logo"><b> Distance:</b>
                        </font>
                        <font class="card-text" id="distanceValueInKm" style="font-size:22px">

                        </font> km
                    </div>


                    <div id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="card-header" role="tab" id="headingOne">
                            <h5 class="mb-0">
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        for future use
                                    </a>
                            </h5>
                        </div>

                        <div id="collapseOne" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                            <div class="card-block">

                            </div>
                        </div>


                        <div class="card">
                            <div class="card-header" role="tab" id="headingTwo">
                                <h5 class="mb-0">
                                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                                            Use Instructions
                                        </a>
                                </h5>
                            </div>

                            <div id="collapseTwo" class="collapse show" role="tabpanel" aria-labelledby="headingTwo">
                                <div class="card-block">
                                    <p class="card-text">
                                        1. Authorize Sight-C-ing to view your current location (preferred) to identify your current location.
                                    </p>
                                    <p class="card-text">
                                        2. Select the
                                        <input class="btn btn-primary" id='uploadbtn' type='button' value='Upload' /> button above to upload.
                                    </p>
                                    <p class="card-text">3. Subsequently, you can also drag and drop files ending with a
                                        <a href="#" data-toggle="tooltip" data-placement="top" title="Can be generated using major GPS trackers or via Google Maps">.GPX</a> extension directly into the map.
                                    </p>
                                    <p class="card-text">
                                        4. Only
                                        <a href="#" data-toggle="tooltip" data-placement="top" title="Can be generated using major GPS trackers or via Google Maps">.GPX</a> files are allowed to upload.
                                    </p>
                                    <p>
                                        <p class="card-text" style="position: justify">
                                            5. The route will then be reflect automatically onto the map.
                                        </p>
                                        <p class="card-text" style="text-decoration: underline">Legend</p>
                                        <p class="card-text">
                                            <img class="w-15" src="https://lh6.ggpht.com/IgJ4d_Edni5_YOTSw7RrUxViTPN8rxDyRV4YAgOKYGT4pLqUVlAh9Ncx70KPqy74Ew=w60" alt="logo"> - Current Location
                                        </p>
                                        <p class="card-text">
                                            <img class="w-15" src="MapIcons/start.png" alt="logo"> - Start Point
                                        </p>
                                        <p class="card-text">
                                            <img class="w-15" src="MapIcons/stop.png" alt="logo"> - End Point
                                        </p>
                                        <p class="card-text">We hope you enjoy using
                                            <b>Sight-C-ing</b>!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Frame -->
            <div id="map"></div>
            <div id="drop-container">
                <div id="drop-silhouette"></div>
            </div>
            <script>
                /* Map functions */

                var map, infoWindow, marker, service, coords;

                var icons = {
                    currentLoc: {
                        icon: "/MapIcons/flag.ico"
                    }
                }

                function initMap() {
                    // set up the map
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: new google.maps.LatLng(1.352083, 103.751959),
                        zoom: 12
                    });

                    infoWindow = new google.maps.InfoWindow;

                    // Try HTML5 geolocation.
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            marker = new google.maps.Marker({
                                position: new google.maps.LatLng(pos.lat, pos.lng),
                                map: map,
                                title: 'Location lor',
                                icon: "https://lh6.ggpht.com/IgJ4d_Edni5_YOTSw7RrUxViTPN8rxDyRV4YAgOKYGT4pLqUVlAh9Ncx70KPqy74Ew=w45"
                            });


                            // infoWindow.setPosition(pos);
                            // infoWindow.setContent('Current Location');
                            // infoWindow.open(map);
                            //map.setCenter(pos, 16);
                        }, function() {
                            handleLocationError(true, infoWindow, map.getCenter());
                        });
                    } else {
                        // Browser doesn't support Geolocation
                        handleLocationError(false, infoWindow, map.getCenter());
                    }
                }

                function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                    infoWindow.setPosition(pos);
                    infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
                    infoWindow.open(map);
                }

                function loadGeoJsonString(geoString) {
                    var geojson = JSON.parse(geoString);
                    map.data.addGeoJson(geojson);
                    map.data.setStyle({
                        fillColor: "yellow",
                        strokeWeight: 10
                    });

                    document.getElementById('distanceMatrix').hidden = "";

                    // landmark search
                    var features = geojson.features;
                    var feature = geojson.features[0];
                    var gg = feature.geometry;

                    for (var i = 0; i < gg.coordinates.length; i += 20) {
                        var coord = gg.coordinates[i];

                        var loc = new google.maps.LatLng(coord[1], coord[0]);
                        var service = new google.maps.places.PlacesService(map);
                        service.nearbySearch({
                            location: loc,
                            radius: 50,
                            type: ["restaurant"]
                        }, test);
                    }

                    coords = [];

                    for (var j = 0; j < gg.coordinates.length; j++) {
                        var coord = gg.coordinates[j];
                        var loc = new google.maps.LatLng(coord[1], coord[0]);
                        coords.push(loc);
                    }

                    zoom(map);
                    if (coords != null) {
                        var totalDistance = Math.round((google.maps.geometry.spherical.computeLength(coords) / 1000) * 100) / 100;
                        document.getElementById("distanceValueInKm").innerHTML = totalDistance;
                    }

                    start_marker = new google.maps.Marker({
                        icon: "MapIcons/start.png",
                        shadow: "",
                        shape: "",
                        position: coords[0],
                        map: map
                    });
                    start_marker.setMap(map);

                    end_marker = new google.maps.Marker({
                        icon: "MapIcons/stop.png",
                        shadow: "",
                        shape: "",
                        position: coords[coords.length - 1],
                        map: map
                    });
                    end_marker.setMap(map);


                }

                /**
                 * Update a map's viewport to fit each geometry in a dataset
                 * @param {google.maps.Map} map The map to adjust
                 */
                function zoom(map) {
                    var bounds = new google.maps.LatLngBounds();
                    map.data.forEach(function(feature) {
                        processPoints(feature.getGeometry(), bounds.extend, bounds);
                    });
                    map.fitBounds(bounds);
                }

                /**
                 * Process each point in a Geometry, regardless of how deep the points may lie.
                 * @param {google.maps.Data.Geometry} geometry The structure to process
                 * @param {function(google.maps.LatLng)} callback A function to call on each
                 *     LatLng point encountered (e.g. Array.push)
                 * @param {Object} thisArg The value of 'this' as provided to 'callback' (e.g.
                 *     myArray)
                 */
                function processPoints(geometry, callback, thisArg, map) {
                    if (geometry instanceof google.maps.LatLng) {
                        callback.call(thisArg, geometry);
                    } else if (geometry instanceof google.maps.Data.Point) {
                        callback.call(thisArg, geometry.get());
                    } else {
                        geometry.getArray().forEach(function(g) {
                            processPoints(g, callback, thisArg);
                        });
                    }
                }

                function test(results, status) {
                    debugger;
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        for (var i = 0; i < results.length; i++) {
                            createMarker(results[i]);
                        }
                    } else {
                        console.log("limit exceed");
                    }
                }

                function createMarker(place) {
                    debugger;
                    var placeLoc = place.geometry.location;
                    var marker = new google.maps.Marker({
                        map: map,
                        position: placeLoc
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                        infowindow.setContent(place.name);
                        infowindow.open(map, this);
                    });
                }


                /* DOM (drag/drop) functions */

                function initEvents() {
                    // set up the drag & drop events
                    var mapContainer = document.getElementById('map');
                    var dropContainer = document.getElementById('drop-container');

                    // map-specific events
                    mapContainer.addEventListener('dragenter', showPanel, false);

                    // overlay specific events (since it only appears once drag starts)
                    dropContainer.addEventListener('dragover', showPanel, false);
                    dropContainer.addEventListener('drop', handleDrop, false);
                    dropContainer.addEventListener('dragleave', hidePanel, false);
                }

                function showPanel(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    document.getElementById('drop-container').style.display = 'block';
                    return false;
                }

                function hidePanel(e) {
                    document.getElementById('drop-container').style.display = 'none';
                }

                function handleDrop(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    hidePanel(e);
                    readFile(e);
                    // prevent drag event from bubbling further
                    return false;
                }

                function readFile(e) {
                    var files = e.dataTransfer.files;
                    if (files.length) {
                        // process file(s) being dropped
                        // grab the file data from each file
                        for (var i = 0, file; file = files[i]; i++) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var result = e.target.result;
                                loadGeoJsonString(JSON.stringify(toGeoJSON["gpx"]((new DOMParser()).parseFromString(result, 'text/xml')), null, 4));
                            };
                            reader.onerror = function(e) {
                                console.error('reading failed');
                            };
                            reader.readAsText(file);
                            document.getElementById('gpxtext').placeholder = file.name;
                            $('#gpxtext').addClass('whiteplaceholder');
                            $('#gpxtext').css({
                                'background-color': '#65ca65'
                            });
                        }
                    } else {
                        // process non-file (e.g. text or html) content being dropped
                        // grab the plain text version of the data
                        var plainText = e.dataTransfer.getData('text/plain');
                        if (plainText) {
                            loadGeoJsonString(plainText);
                        }
                    }

                    // infoWindow = new google.maps.InfoWindow;

                    // var lctn = {
                    //     lat: map.getCenter().lat(),
                    //     lng: map.getCenter().lng()
                    // };

                    // var service = new google.maps.places.PlacesService(map);
                    // service.nearbySearch({
                    //     location: lctn,
                    //     radius: 2000,
                    //     type: ['store']
                    // }, callGooglePlaces);
                }

                function setup() {
                    var fullPath = '';
                    document.getElementById('uploadbtn').addEventListener('click', openDialog);

                    function openDialog() {
                        document.getElementById('myFile').click();
                        fullPath = document.getElementById('myFile').value;
                    }

                    function handleFileSelect(evt) {
                        var files = evt.target.files; // FileList object

                        for (var i = 0, f; f = files[i]; i++) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var result = e.target.result;
                                loadGeoJsonString(JSON.stringify(toGeoJSON["gpx"]((new DOMParser()).parseFromString(result, 'text/xml')), null, 4));
                            };
                            reader.onerror = function(e) {
                                console.error('reading failed');
                            };
                            reader.readAsText(f);
                            document.getElementById('gpxtext').placeholder = f.name;
                            $('#gpxtext').addClass('whiteplaceholder');
                            $('#gpxtext').css({
                                'background-color': '#65ca65'
                            });
                        }
                    }

                    document.getElementById('myFile').addEventListener('change', handleFileSelect, false);
                }

                function initialize() {
                    initMap();
                    initEvents();
                    //readFile();
                }

                $(document).ready(function() {
                    $('[data-toggle="tooltip"]').tooltip();
                });
            </script>
            <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCysefPogjMjWtUQsqWKr_Hap4YrdxAoeo&libraries=places&callback=initialize"></script>
            <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCysefPogjMjWtUQsqWKr_Hap4YrdxAoeo&libraries=geometry&callback=initialize"></script>
        </div>
    </div>
</body>